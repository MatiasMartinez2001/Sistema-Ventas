<div class="container my-5">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="mb-3">Gesti√≥n de Pedidos</h1>
      <div class="d-flex gap-2 mb-3">
        <button 
          class="btn btn-primary" 
          (click)="toggleFormulario()"
          type="button">
          {{ mostrarFormulario ? 'Cancelar' : '+ Crear Nuevo Pedido' }}
        </button>
        <button 
          class="btn btn-secondary" 
          (click)="toggleHistorial()"
          type="button">
          {{ mostrarHistorial ? 'Ocultar' : 'Ver' }} Historial de Pedidos
        </button>
      </div>
    </div>
  </div>

  <!-- Formulario para crear pedido -->
  <div class="row mb-4" *ngIf="mostrarFormulario">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Nuevo Pedido</h5>
        </div>
        <div class="card-body">
          <!-- Selecci√≥n de Cliente -->
          <div class="mb-4">
            <h5 class="mb-3">1. Seleccionar Cliente</h5>
            <div *ngIf="clientes().length === 0" class="alert alert-warning">
              No hay clientes registrados. Por favor, crea un cliente primero.
            </div>
            <div *ngIf="clientes().length > 0" class="row">
              <div class="col-md-6 mb-3" *ngFor="let cliente of clientes()">
                <div 
                  class="card h-100 cursor-pointer"
                  [class.border-primary]="clienteSeleccionado?.id === cliente.id"
                  [class.bg-light]="clienteSeleccionado?.id === cliente.id"
                  (click)="seleccionarCliente(cliente)"
                  style="cursor: pointer;">
                  <div class="card-body">
                    <h6 class="card-title">{{ cliente.nombre }}</h6>
                    <p class="card-text mb-1">
                      <small class="text-muted">Email: {{ cliente.email }}</small>
                    </p>
                    <p class="card-text mb-0">
                      <small class="text-muted">Tel: {{ cliente.telefono }}</small>
                    </p>
                    <span *ngIf="clienteSeleccionado?.id === cliente.id" class="badge bg-primary mt-2">
                      ‚úì Seleccionado
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Selecci√≥n de Productos -->
          <div class="mb-4" *ngIf="clienteSeleccionado">
            <h5 class="mb-3">2. Selecciona Productos para Agregar al Carrito</h5>
            <div *ngIf="productos().length === 0" class="alert alert-warning">
              No hay productos disponibles. Por favor, crea productos primero.
            </div>
            <div *ngIf="productos().length > 0">
              <!-- Filtro por categor√≠a -->
              <div class="mb-3">
                <label class="form-label"><strong>Filtrar por categor√≠a:</strong></label>
                <select class="form-select" [(ngModel)]="categoriaFiltro" (change)="filtrarProductos()">
                  <option value="">Todas las categor√≠as</option>
                  <option value="Maquillaje">Maquillaje</option>
                  <option value="Cuidado de la Piel">Cuidado de la Piel</option>
                  <option value="Fragancias">Fragancias</option>
                  <option value="Accesorios">Accesorios</option>
                </select>
              </div>
              
              <!-- Grid de productos con im√°genes -->
              <div class="row g-3">
                <div class="col-md-4 col-sm-6" *ngFor="let producto of productosFiltrados()">
                  <div class="product-card" [class.disabled]="producto.stock === 0">
                    <div class="product-image">
                      <div class="product-icon">{{ obtenerIconoProducto(producto.categoria || '') }}</div>
                      <div class="product-overlay">
                        <button 
                          class="btn btn-success btn-sm"
                          (click)="agregarAlCarrito(producto)"
                          [disabled]="producto.stock === 0">
                          <span *ngIf="producto.stock > 0">+ Agregar</span>
                          <span *ngIf="producto.stock === 0">Sin Stock</span>
                        </button>
                      </div>
                    </div>
                    <div class="product-info">
                      <h6 class="product-name">{{ producto.nombre }}</h6>
                      <p class="product-description">{{ producto.descripcion }}</p>
                      <div class="product-details">
                        <div class="product-category">
                          <span class="badge bg-secondary">{{ producto.categoria || 'Sin categor√≠a' }}</span>
                        </div>
                        <div class="product-price">{{ formatearPrecio(producto.precio) }}</div>
                        <div class="product-stock">
                          <span [class]="producto.stock < 10 ? 'badge bg-warning' : 'badge bg-success'">
                            Stock: {{ producto.stock }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Carrito de Compras -->
          <div class="mb-4 carrito-section" *ngIf="carrito.length > 0">
            <h5 class="mb-3">3. Carrito de Compras</h5>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Producto</th>
                    <th>Precio Unitario</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acci√≥n</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of carrito; let i = index">
                    <td>
                      <strong>{{ item.producto.nombre }}</strong>
                      <br>
                      <small class="text-muted">{{ item.producto.descripcion }}</small>
                    </td>
                    <td>{{ formatearPrecio(item.producto.precio) }}</td>
                    <td>
                      <div class="input-group input-group-sm" style="max-width: 120px;">
                        <button 
                          class="btn btn-outline-secondary" 
                          type="button"
                          (click)="actualizarCantidad(item, item.cantidad - 1)">
                          -
                        </button>
                        <input 
                          type="number" 
                          class="form-control text-center" 
                          [(ngModel)]="item.cantidad"
                          (change)="actualizarCantidad(item, item.cantidad)"
                          min="1"
                          [max]="item.producto.stock">
                        <button 
                          class="btn btn-outline-secondary" 
                          type="button"
                          (click)="actualizarCantidad(item, item.cantidad + 1)">
                          +
                        </button>
                      </div>
                    </td>
                    <td><strong>{{ formatearPrecio(item.subtotal) }}</strong></td>
                    <td>
                      <button 
                        class="btn btn-sm btn-danger"
                        (click)="eliminarDelCarrito(i)"
                        title="Eliminar del carrito">
                        üóëÔ∏è
                      </button>
                    </td>
                  </tr>
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                    <td colspan="2"><strong class="text-primary fs-5">{{ formatearPrecio(calcularTotal()) }}</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="d-flex justify-content-end">
              <button 
                class="btn btn-success btn-lg"
                (click)="crearPedido()"
                [disabled]="!clienteSeleccionado || carrito.length === 0">
                ‚úì Crear Pedido
              </button>
            </div>
          </div>

          <!-- Mensaje cuando no hay cliente seleccionado -->
          <div *ngIf="!clienteSeleccionado && clientes().length > 0" class="alert alert-info">
            Por favor, selecciona un cliente para continuar.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Historial de Pedidos -->
  <div class="row" *ngIf="mostrarHistorial">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üìã Todos los Pedidos Guardados ({{ pedidos().length }})</h5>
        </div>
        <div class="card-body">
          <div *ngIf="pedidos().length === 0" class="alert alert-info">
            <strong>No hay pedidos registrados a√∫n.</strong>
            <p class="mb-0 mt-2">Crea tu primer pedido usando el bot√≥n "Crear Nuevo Pedido".</p>
          </div>

          <div *ngIf="pedidos().length > 0" class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Cliente</th>
                  <th>Cantidad de √çtems</th>
                  <th>Total</th>
                  <th>Fecha</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pedido of pedidos()">
                  <td>
                    <strong>{{ pedido.cliente.nombre }}</strong>
                    <br>
                    <small class="text-muted">
                      üìß {{ pedido.cliente.email }}
                      <span *ngIf="pedido.cliente.telefono"> | üìû {{ pedido.cliente.telefono }}</span>
                    </small>
                  </td>
                  <td>
                    <span class="badge bg-secondary fs-6">
                      {{ obtenerCantidadItems(pedido) }} {{ obtenerCantidadItems(pedido) === 1 ? '√≠tem' : '√≠tems' }}
                    </span>
                    <br>
                    <small class="text-muted">{{ pedido.items.length }} {{ pedido.items.length === 1 ? 'producto' : 'productos' }}</small>
                  </td>
                  <td>
                    <strong class="text-success fs-5">{{ formatearPrecio(pedido.total) }}</strong>
                  </td>
                  <td>
                    <strong>{{ pedido.fechaCreacion | date:'dd/MM/yyyy' }}</strong>
                    <br>
                    <small class="text-muted">{{ pedido.fechaCreacion | date:'HH:mm' }}</small>
                  </td>
                  <td>
                    <span class="badge bg-info">{{ pedido.estado || 'Pendiente' }}</span>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <button 
                        class="btn btn-info btn-sm"
                        (click)="verDetalles(pedido)"
                        title="Ver detalles del pedido">
                        üëÅÔ∏è Ver Detalles
                      </button>
                      <button 
                        class="btn btn-danger btn-sm"
                        (click)="eliminarPedido(pedido.id)"
                        title="Eliminar pedido">
                        üóëÔ∏è Eliminar
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalles del Pedido -->
  <div class="modal fade" [class.show]="mostrarDetalles" [style.display]="mostrarDetalles ? 'block' : 'none'" 
       tabindex="-1" role="dialog" *ngIf="pedidoSeleccionado">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">üìÑ Detalles del Pedido</h5>
          <button type="button" class="btn-close btn-close-white" (click)="cerrarDetalles()" aria-label="Close"></button>
        </div>
        <div class="modal-body" *ngIf="pedidoSeleccionado">
          <!-- Informaci√≥n del Cliente -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">üë§ Informaci√≥n del Cliente</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-1"><strong>Nombre:</strong> {{ pedidoSeleccionado.cliente.nombre }}</p>
                  <p class="mb-1"><strong>Email:</strong> {{ pedidoSeleccionado.cliente.email }}</p>
                  <p class="mb-0"><strong>Tel√©fono:</strong> {{ pedidoSeleccionado.cliente.telefono }}</p>
                </div>
                <div class="col-md-6" *ngIf="pedidoSeleccionado.cliente.direccion">
                  <p class="mb-0"><strong>Direcci√≥n:</strong> {{ pedidoSeleccionado.cliente.direccion }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n del Pedido -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">üì¶ Productos del Pedido</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Producto</th>
                      <th>Precio Unitario</th>
                      <th>Cantidad</th>
                      <th>Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of pedidoSeleccionado.items">
                      <td>
                        <strong>{{ item.producto.nombre }}</strong>
                        <br>
                        <small class="text-muted">{{ item.producto.descripcion }}</small>
                        <br>
                        <small class="text-muted">Categor√≠a: {{ item.producto.categoria || 'Sin categor√≠a' }}</small>
                      </td>
                      <td>{{ formatearPrecio(item.producto.precio) }}</td>
                      <td>
                        <span class="badge bg-secondary">{{ item.cantidad }}</span>
                      </td>
                      <td><strong>{{ formatearPrecio(item.subtotal) }}</strong></td>
                    </tr>
                  </tbody>
                  <tfoot class="table-light">
                    <tr>
                      <td colspan="3" class="text-end"><strong>Total del Pedido:</strong></td>
                      <td><strong class="text-success fs-5">{{ formatearPrecio(pedidoSeleccionado.total) }}</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>

          <!-- Resumen del Pedido -->
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="mb-0">üìä Resumen del Pedido</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-1"><strong>ID del Pedido:</strong> <small>{{ pedidoSeleccionado.id }}</small></p>
                  <p class="mb-1"><strong>Fecha de Creaci√≥n:</strong> {{ pedidoSeleccionado.fechaCreacion | date:'full' }}</p>
                  <p class="mb-0"><strong>Estado:</strong> <span class="badge bg-info">{{ pedidoSeleccionado.estado || 'Pendiente' }}</span></p>
                </div>
                <div class="col-md-6">
                  <p class="mb-1"><strong>Total de √çtems:</strong> {{ obtenerCantidadItems(pedidoSeleccionado) }}</p>
                  <p class="mb-1"><strong>Cantidad de Productos:</strong> {{ pedidoSeleccionado.items.length }}</p>
                  <p class="mb-0"><strong>Total:</strong> <span class="text-success fs-5">{{ formatearPrecio(pedidoSeleccionado.total) }}</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cerrarDetalles()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade" [class.show]="mostrarDetalles" [style.display]="mostrarDetalles ? 'block' : 'none'" (click)="cerrarDetalles()"></div>
</div>
